steps:

- name: python
  entrypoint: '/bin/bash'
  args: [ '-c', 'source ./venv/bin/activate; pip install -r requirements.txt; python3 -m unittest discover' ]

- name: 'us.gcr.io/$PROJECT_ID/sonar-scanner:4.6.0.2311'
  args: ['-c', '/opt/sonar-scanner-4.6.0.2311-linux/bin/sonar-scanner -Dsonar.host.url=https://sonarcloud.io -Dsonar.login=$$TOKEN -Dsonar.projectKey=Sahay-ohikc_ci-cd-tutorial-sample-app -Dsonar.organization=sahay-ohikc -Dsonar.sources=.' ]
  secretEnv: ['TOKEN']
  entrypoint: 'bash'
  secretEnv:
    - TOKEN

# Docker Build
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'us-docker.pkg.dev/${PROJECT_ID}/us.gcr.io/sample-ci-cd:${SHORT_SHA}', '.']

availableSecrets:
  secretManager:
  - versionName: projects/$PROJECT_ID/secrets/sonarqube-token/versions/latest
    env: TOKEN
